name: Dockerfile

on:
  push:
    branches:
      - master
  create:
    tags:      
  pull_request:
  release:
    types: [published]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_protected == 'true' && github.sha || github.ref }}
  cancel-in-progress: true

env:
  HEAD_SHA: ${{ github.event.pull_request.head.sha || github.sha }}
  IMAGE: ${{ format('{0}/{1}:{2}', secrets.DOCKERHUB_TOKEN && 'docker.io' || 'ghcr.io', github.repository,  github.event.ref || 'latest') }}
  CORE_GIT_REF: master
  CORE_COMPILE_CONFIGURE_FLAGS: "--disable-tests --enable-next-protocol-version-unsafe-for-production"
  SOROBAN_RPC_GIT_REF: main
  RUST_TOOLCHAIN_VERSION: stable
  SOROBAN_CLI_GIT_REF: main
  QUICKSTART_GIT_REF: master
  #SYSTEM_TEST_PUSH_ENABLED: ${{ github.event_name == 'create' && github.event.ref_type == 'tag' && startsWith(github.event.ref, 'v') != true && 'true' || 'false' }}
  SYSTEM_TEST_PUSH_ENABLED: 'false'
  DOCKERHUB_ENABLED: ${{ secrets.DOCKERHUB_TOKEN && 'true' || 'false' }} 
jobs:
  complete:
    if: always()
    needs: [build]
    runs-on: ubuntu-latest
    steps:
    - if: contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled')
      run: exit 1

  build:
    # The purpose of build is to just validate that the system test build process works,
    # in most workflows, no resulting image is pushed to a repo, because system test is meant to
    # be built locally for speciric testing context by specifying the component versions first.
    # One case of workflow will trigger a push of built image and that is new tags that don't start with 'v'
    # These are to create pre-built images of a specific release train, such as Soroban releases.
    # A branch should be created, sets the git ref versions on componsnets for a release in the env block and then tag that
    # branch as 'soroban-release-preview6' etc. This will trigger gh workflow, and resulting system test image 
    # will be stellar/system-test:soroban-release-preview6, a reuasable test image, pinned to the specific release stack.
    runs-on: ubuntu-latest
    permissions: 
      packages: write
    steps:
    - uses: actions/checkout@v2
      with:
        ref: ${{ env.HEAD_SHA }}
    - uses: docker/setup-buildx-action@v2
    - uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ github.token }}
    - if: ${{ env.SYSTEM_TEST_PUSH_ENABLED == 'true' && env.DOCKERHUB_ENABLED == 'true' }}
      uses: docker/login-action@v2
      with:
        registry: docker.io
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - name: Build System Test Image
      run: |
        make CORE_GIT_REF=${{ env.CORE_GIT_REF }} \
             CORE_COMPILE_CONFIGURE_FLAGS="${{ env.CORE_COMPILE_CONFIGURE_FLAGS }}" \
             SOROBAN_RPC_GIT_REF=${{ env.SOROBAN_RPC_GIT_REF }} \
             RUST_TOOLCHAIN_VERSION=${{ env.RUST_TOOLCHAIN_VERSION }} \
             SOROBAN_CLI_GIT_REF=${{ env.SOROBAN_CLI_GIT_REF }} \
             QUICKSTART_GIT_REF=${{ env.QUICKSTART_GIT_REF }} \
             DOCKER_CACHE_REGISTRY=ghcr.io/${{ github.event.pull_request.head.repo.owner.name || github.repository_owner }} \
             SYSTEM_TEST_PUSH_IMAGE=${{ env.SYSTEM_TEST_PUSH_ENABLED == 'true' && env.IMAGE || '' }} \
             build-with-registry-cache;
  