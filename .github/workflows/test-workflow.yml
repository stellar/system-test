name: Systems test workflow, next gen, uses quickstart pipelines

on:
  workflow_call:
    secrets:
      DOCKERHUB_USERNAME:
        required: false
      DOCKERHUB_TOKEN:
        required: false
    inputs:
      runner:
        description: "GitHub runner to use"
        required: false
        type: string
        default: "ubuntu-latest"

      system-test-git-ref:
        description: "the git ref (branch, tag, sha) to use for system-test"
        required: false
        type: string
        default: master   

      stellar-cli-ref:
        description: |
          the soroban CLI source code to compile and run from system test
          refers to checked out source of current GitHub ref context or branch
        required: false
        type: string

      stellar-cli-version:
        required: false
        type: string
        default: "23.0.0"

      test-filter:
        description: |
          example filter for all combos of one scenario outline: ^TestDappDevelop$/^DApp developer compiles, deploys and invokes a contract.*$
          each row in example data for a scenario outline is postfixed with '#01', '#02', example:
          TestDappDevelop/DApp developer compiles, deploys and invokes a contract#01
        required: false
        type: string
        default: "^TestDappDevelop$/^.*$"

      js-stellar-sdk-npm-version:
        description: |
          set the version of js-stellar-sdk to use, need to choose one of either
          resolution options, using npm release or a gh ref:
          option #1, set the version of stellar-sdk based on a npm release version
        required: false
        type: string
        default: 14.0.0-rc.3

      js-stellar-sdk-gh-repo:
        description: |
          option #2, set the version of stellar-sdk based on a gh repo, e.g. stellar/js-stellar-sdk
          if set, takes precedence over js-stellar-sdk-npm-version
        required: false
        type: string

      js-stellar-sdk-gh-ref:
        description: "The git ref (branch, tag, sha) to use for js-stellar-sdk if using gh repo option"
        required: false
        type: string  

      stellar-xdr-version:
        description: "Version of stellar-xdr to use"
        required: false
        type: string
        default: "v23.0.0"

      stellar-core-version:
        description: "Version of stellar-core to use"
        required: false
        type: string
        default: "v23.0.1"

      horizon-version:
        description: "Version of horizon to use"
        required: false
        type: string
        default: "horizon-v23.0.0"

      lab-version:
        description: "Version of stellar laboratory to use"
        required: false
        type: string
        default: "main"

      protocol-version:
        description: "Protocol version to use"
        required: false
        type: string
        default: "23"

      rust-toolchain-version:
        description: "Version of Rust toolchain to use in test runtime environment"
        required: false
        type: string
        default: "stable"

      verbose-output:
        required: false
        type: boolean
        default: true

      soroban-examples-git-hash:
        description: "The git ref (branch, tag, sha) to use for soroban-examples"
        required: false
        type: string
        default: "v22.0.1"
        
      soroban-examples-repo-url:
        description: "The git repo URL to use for soroban-examples"
        required: false
        type: string
        default: "https://github.com/stellar/soroban-examples"

env:
  SYSTEM_TEST_IMAGE: stellar/system-test:cache
  SYSTEM_TEST_IMAGE_CACHE_REGISTRY: docker.io
  
jobs:
  prepare-config:
    runs-on: ubuntu-latest
    outputs:
      images-config: ${{ steps.set-config.outputs.images }}
      system-test-image-cache-registry: ${{ env.SYSTEM_TEST_IMAGE_CACHE_REGISTRY }}
      system-test-image-cached: "${{ env.SYSTEM_TEST_IMAGE}}_${{ steps.set-cache-key.outputs.cache-key }}"
      registry_allowed: ${{ steps.check-registry.outputs.registry-allowed }}
    steps:
      - id: check-registry
        name: Check if registry access is allowed
        run: |
          if [ -z "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
            echo "registry-allowed=false" >> $GITHUB_OUTPUT
          else
            echo "registry-allowed=true" >> $GITHUB_OUTPUT
          fi 
      - id: set-cache-key
        run: |
          # Fetch commit SHAs for each dependency repo

          SYSTEM_TEST_SHA=$(git ls-remote https://github.com/stellar/system-test ${{ inputs.system-test-git-ref }} | awk '{print $1}')
          if [ -z "$SYSTEM_TEST_SHA" ]; then
            echo "Error: Could not find ref ${{ inputs.system-test-git-ref }} in stellar/system-test"
            exit 1
          fi

          # Parse STELLAR_CLI_REF which is in format: URL#ref
          CLI_URL_REF="${{ inputs.stellar-cli-ref }}"
          
          # Only fetch if stellar-cli-ref is provided
          if [ -n "$CLI_URL_REF" ]; then
            # Split on # to get URL and ref
            CLI_URL=$(echo "$CLI_URL_REF" | cut -d'#' -f1)
            CLI_REF=$(echo "$CLI_URL_REF" | cut -d'#' -f2)
            
            STELLAR_CLI_SHA=$(git ls-remote "$CLI_URL" "$CLI_REF" | awk '{print $1}')
            if [ -z "$STELLAR_CLI_SHA" ]; then
              echo "Error: Could not find ref $CLI_REF in $CLI_URL"
              exit 1
            fi
          else
            # If no CLI ref provided
            STELLAR_CLI_SHA="${{ inputs.stellar-cli-version }}"
          fi

          # Handle JS Stellar SDK
          if [ -n "${{ inputs.js-stellar-sdk-gh-repo }}" ]; then
            JS_SDK_PART=$(git ls-remote https://github.com/${{ inputs.js-stellar-sdk-gh-repo }} ${{ inputs.js-stellar-sdk-gh-ref }} | awk '{print $1}')
            if [ -z "$JS_SDK_PART" ]; then
              echo "Error: Could not find ref ${{ inputs.js-stellar-sdk-gh-ref }} in ${{ inputs.js-stellar-sdk-gh-repo }}"
              exit 1
            fi
          else
            JS_SDK_PART="${{ inputs.js-stellar-sdk-npm-version }}"
          fi

          # Create cache key by hashing all components
          CACHE_INPUT="${SYSTEM_TEST_SHA}${STELLAR_CLI_SHA}${JS_SDK_PART}"
          CACHE_KEY=$(echo -n "$CACHE_INPUT" | sha256sum | cut -c1-16)
          echo "cache-key=${CACHE_KEY}" >> $GITHUB_OUTPUT
          echo "Generated cache key: ${CACHE_KEY}"

      - id: set-config
        run: |
          cat <<EOF >> $GITHUB_OUTPUT
          images<<DELIMITER
          [
            {
              "tag": "rpc-custom",
              "config": {
                "protocol_version_default": ${{ inputs.protocol-version }}
              },
              "deps": [
                { "name": "xdr", "repo": "stellar/rs-stellar-xdr", "ref": "${{ inputs.stellar-xdr-version }}" },
                { "name": "core", "repo": "stellar/stellar-core", "ref": "${{ inputs.stellar-core-version }}", "options": { "configure_flags": "--disable-tests" } },
                { "name": "rpc", "repo": "${{ github.repository }}", "ref": "${{ github.ref }}" },
                { "name": "horizon", "repo": "stellar/go", "ref": "${{ inputs.horizon-version }}" },
                { "name": "friendbot", "repo": "stellar/go", "ref": "${{ inputs.horizon-version }}" },
                { "name": "lab", "repo": "stellar/laboratory", "ref": "${{ inputs.lab-version }}" }
              ],
              "additional-tests": []
            }
          ]
          DELIMITER
          EOF
  build-quickstart:
      needs: prepare-config
      uses: stellar/quickstart/.github/workflows/build.yml@main
      with:
        images: ${{ needs.prepare-config.outputs.images-config }}
        archs: '["amd64"]'

  check-system-test-cache:
    runs-on: ubuntu-latest
    needs: prepare-config
    outputs:
      cache-hit: ${{ steps.check.outputs.exists }}
    steps:
      - id: check
        name: Check if cached system-test image exists
        run: |
          if docker manifest inspect ${{ needs.prepare-config.outputs.system-test-image-cache-registry }}/${{ needs.prepare-config.outputs.system-test-image-cached }} > /dev/null 2>&1; then
            echo "Image exists in registry"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Image not found in registry"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

  build-system-test:
    runs-on: ubuntu-latest-4-cores
    needs: [prepare-config, check-system-test-cache]
    if: needs.check-system-test-cache.outputs.cache-hit != 'true'
    env:
      SYSTEM_TEST_IMAGE: ${{ needs.prepare-config.outputs.system-test-image-cached }}
    steps:
      - uses: actions/checkout@v3
        with:
          repository: stellar/system-test
          ref: ${{ inputs.system-test-git-ref }}
          path: system-test

      - if: inputs.js-stellar-sdk-gh-repo != ''
        name: prepare local js-stellar-sdk
        run: |
          rm -rf $GITHUB_WORKSPACE/system-test/js-stellar-sdk;

      - if: inputs.js-stellar-sdk-gh-repo != ''
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.js-stellar-sdk-gh-repo }}
          ref: ${{ inputs.js-stellar-sdk-gh-ref }}
          path: system-test/js-stellar-sdk

      - uses: stellar/actions/rust-cache@main

      - name: Build system test with component versions
        run: |
          cd $GITHUB_WORKSPACE/system-test
          if [ -z "${{ inputs.js-stellar-sdk-gh-repo }}" ]; then \
            JS_STELLAR_SDK_REF="${{ inputs.js-stellar-sdk-npm-version }}"; \
          else \
            JS_STELLAR_SDK_REF="file:/home/tester/js-stellar-sdk"; \
          fi
          make \
            STELLAR_CLI_GIT_REF=${{ inputs.stellar-cli-ref }} \
            RUST_TOOLCHAIN_VERSION=${{ inputs.rust-toolchain-version }} \
            JS_STELLAR_SDK_NPM_VERSION=$JS_STELLAR_SDK_REF \
            SYSTEM_TEST_IMAGE=$SYSTEM_TEST_IMAGE \
            build
      - name: login to registry
        if: needs.prepare-config.outputs.registry_allowed == 'true'
        uses: docker/login-action@f054a8b539a109f9f41c372932f1ae047eff08c9
        with:
          registry: ${{ needs.prepare-config.outputs.system-test-image-cache-registry }}
          username: ${{ secrets.DOCKERHUB_USERNAME  }}
          password: ${{ secrets.DOCKERHUB_TOKEN  }}
      - name: Publish system-test image
        if: needs.prepare-config.outputs.registry_allowed == 'true'
        run: |
          docker tag $SYSTEM_TEST_IMAGE ${{ needs.prepare-config.outputs.system-test-image-cache-registry }}/$SYSTEM_TEST_IMAGE
          docker push ${{ needs.prepare-config.outputs.system-test-image-cache-registry }}/$SYSTEM_TEST_IMAGE

      - name: extract image to artifact when no registry
        if: needs.prepare-config.outputs.registry_allowed != 'true'
        run: |
          docker save $SYSTEM_TEST_IMAGE -o /tmp/image.tar
      - name: save to artifact when no registry
        if: needs.prepare-config.outputs.registry_allowed != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: image-system-test
          path: /tmp/image.tar

  integration:
    name: System tests
    needs: [build-system-test, build-quickstart, prepare-config]
    # Run if build-system-test succeeded OR was skipped because image is already in built(cache hit)
    if: needs.build-system-test.result == 'success' || needs.build-system-test.result == 'skipped'
    
    strategy:
      matrix:
        scenario-filter: ["${{ inputs.test-filter }}"]
    runs-on: ubuntu-latest
    env:
      SYSTEM_TEST_IMAGE: ${{ needs.prepare-config.outputs.system-test-image-cached }}
    steps:
      - name: Start quickstart with rpc
        uses: stellar/quickstart@main
        with:
          artifact: image-quickstart-rpc-custom-amd64.tar
          tag: rpc-custom-amd64
          enable: core,rpc
      - name: download system-test image
        if: needs.build-system-test.result == 'skipped'
        run: |
          docker pull ${{ needs.prepare-config.outputs.system-test-image-cache-registry }}/$SYSTEM_TEST_IMAGE
          docker tag ${{ needs.prepare-config.outputs.system-test-image-cache-registry }}/$SYSTEM_TEST_IMAGE $SYSTEM_TEST_IMAGE

      - name: download artifact if no registry
        if: needs.build-system-test.result != 'skipped' && needs.prepare-config.outputs.registry_allowed != 'true'
        uses: actions/download-artifact@v4
        with:
          name: image-system-test
          path: /tmp/

      - name: load system-test image if no registry
        if: needs.build-system-test.result != 'skipped' && needs.prepare-config.outputs.registry_allowed != 'true'
        run: |
          docker load -i /tmp/image.tar
          
      - name: Run system test scenarios
        run: |
          docker run \
          --add-host=host.docker.internal:host-gateway \
          --rm -t --name e2e_test $SYSTEM_TEST_IMAGE \
          --VerboseOutput ${{ inputs.verbose-output }}  \
          --TargetNetworkRPCURL http://host.docker.internal:8000/rpc \
          --TestFilter "${{ matrix.scenario-filter }}" \
          --SorobanExamplesGitHash ${{ inputs.soroban-examples-git-hash }} \
          --SorobanExamplesRepoURL ${{ inputs.soroban-examples-repo-url }}